services:

# ============================================
# Backend Service
# ============================================
  backend:

    build:
      context: ./backend
      dockerfile: Dockerfile

    container_name: backend_8D_Platform

    env_file:
      - ./backend/.env

    environment:
      - MODE=dev

    volumes:
      - ./backend:/var/www/html
    ports:
      - "9000:9000"

    depends_on:
      db:
        condition: service_healthy

    command: ["dev"]

    networks:
      - backend_net


# ============================================
# Nginx Service
# ============================================
  nginx:

    image: nginx:alpine
  
    container_name: 8d_nginx_server

    ports:
      - "80:80"

    volumes:
      - ./backend:/var/www/html 
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf

    depends_on:
      - backend
  
    networks:
      - backend_net
      - frontend_net
  
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/problems/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s


# ============================================
# Database Service
# ============================================
  db:

    image: mysql:8.0

    container_name: 8d_db 

    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_USER=${DB_USERNAME}

    volumes:
      - db_data:/var/lib/mysql

    ports:
      - "3306:3306"

    networks:
      - backend_net

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


# ============================================
# Container Volumes
# ============================================
volumes:  
  db_data:

# ============================================
# Container Networks
# ============================================
networks:
  backend_net:
    driver: bridge
  frontend_net:
    driver: bridge